<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode/RFID Scanner - Fox Control Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #CC79F0;
      --secondary-color: #3E7EF7;
      --border-color: #F3F3F3;
      --success-color: #00B146;
      --danger-color: #CF2C3A;
      --warning-color: #FFA300;
      --main-bg: #FDFFFA;
      --bg-shadow: #F3F3F3;
      --table-row1: #F7F5FC;
      --table-row2: #F1EDF9;
      --table-bg: #F8F8F8;
      --bar-graph: #6E62BF;
      --confirmed: #1979FE;
      --header-color: #333135;
      --sub-header: #5F5B62;
      --tertiary-header: #2E2E38;
      --body-font: #4A4A4A;
      --pie-color1: #8979FF;
      --pie-color2: #FF928A;
      --pie-color3: #3CC3DF;
      --pie-color4: #FFAE4C;
      --pie-color5: #537FF1;
    }

    body {
      background-color: var(--main-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
    }

    .sidebar {
      height: 100vh;
      background-color: var(--main-bg);
      border-right: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      overflow-y: auto;
    }

    .sidebar .nav-link {
      color: var(--header-color);
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin: 2px 0;
      transition: all 0.3s ease;
    }

    .sidebar .nav-link:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .sidebar .nav-link.active {
      background-color: var(--secondary-color);
      color: var(--main-bg);
    }

    .top-panel {
      background-color: var(--bg-shadow);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-buttons .btn {
      margin: 0.25rem;
      min-width: 140px;
      font-weight: 500;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }

            .action-buttons .btn:hover {
            background-color: var(--tertiary-header);
            transform: translateY(-2px);
        }

    .action-buttons .btn i {
      font-size: 1.2rem;
      margin-right: 0.5rem;
    }

            .scanner-card {
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 1.5rem;
            background: var(--main-bg);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

            .scanner-card h5 {
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
        }

    .scanner-area {
      background: var(--bg-shadow);
      border: 2px dashed var(--border-color);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1rem;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .scanner-area.active {
      border-color: var(--success-color);
      background-color: var(--table-row1);
    }

    .scanner-input {
      font-size: 1.2rem;
      text-align: center;
      border: 2px solid var(--secondary-color);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .scanner-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(209, 144, 0, 0.25);
    }

    .scan-result {
      background: var(--main-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .scan-history {
      max-height: 300px;
      overflow-y: auto;
    }

    .scan-item {
      background: var(--bg-shadow);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 4px solid var(--primary-color);
    }

    .scan-item.barcode {
      border-left-color: var(--secondary-color);
    }

    .scan-item.rfid {
      border-left-color: var(--success-color);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }

    .status-ready {
      background-color: var(--success-color);
    }

    .status-scanning {
      background-color: var(--warning-color);
      animation: pulse 1s infinite;
    }

    .status-error {
      background-color: var(--danger-color);
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .scanner-controls {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .scanner-controls .btn {
      min-width: 100px;
    }

    /* Top Navigation */
    .top-navbar {
      background: linear-gradient(135deg, var(--main-bg) 0%, var(--bg-shadow) 100%);
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 1030;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .top-navbar .navbar-brand {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .top-navbar .navbar-nav .nav-link {
      color: var(--sub-header);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .top-navbar .navbar-nav .nav-link:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .dropdown-menu {
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 8px;
      padding: 0.5rem 0;
      min-width: 200px;
    }

    .dropdown-item {
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .dropdown-item:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .dropdown-divider {
      margin: 0.5rem 0;
    }

    .notification-item {
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      background-color: var(--bg-shadow);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--sub-header);
      margin-bottom: 0.25rem;
    }

    .notification-text {
      font-size: 0.75rem;
      color: var(--body-font);
      margin-bottom: 0.25rem;
    }

    .notification-time {
      font-size: 0.7rem;
      color: var(--body-font);
    }

    .notification-unread {
      background-color: var(--table-row1);
      border-left: 3px solid var(--primary-color);
    }

    /* Responsive adjustments for top nav */
    @media (max-width: 992px) {
      .top-navbar {
        padding: 0.5rem 1rem;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-buttons .btn {
        width: 100%;
        margin: 0.25rem 0;
      }
    }

    /* Item lookup modal styles */
    .item-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .item-details strong {
      color: var(--primary-color);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .quantity-controls input {
      width: 80px;
      text-align: center;
    }

    .quantity-actions {
      margin-top: 1rem;
    }

    .quantity-actions .btn {
      margin: 0.25rem;
    }

    /* Item lookup modal styles */
    .item-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .item-details strong {
      color: var(--primary-color);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .quantity-controls input {
      width: 80px;
      text-align: center;
    }

    .quantity-actions {
      margin-top: 1rem;
    }

    .quantity-actions .btn {
      margin: 0.25rem;
    }
    
    .barcode-section {
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }
    
    .barcode-item {
      text-align: center;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--main-bg);
    }
    
    .barcode-display {
      margin: 0.5rem 0;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .barcode-display canvas {
      max-width: 100%;
      height: auto;
    }
    
    .barcode-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .barcode-item-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      background-color: var(--main-bg);
      transition: all 0.3s ease;
    }
    
    .barcode-item-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .barcode-item-card h6 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }
    
    .barcode-item-card .item-info {
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .barcode-item-card .barcode-preview {
      text-align: center;
      margin: 1rem 0;
      padding: 0.5rem;
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .barcode-item-card .barcode-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
<!-- Top Navigation -->
<nav class="navbar navbar-expand-lg top-navbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <i class="bi bi-boxes me-2"></i>Fox Control Hub
    </a>

    <!-- Right side navigation -->
    <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
      <!-- Search (hidden on mobile) -->
      <div class="nav-item me-3 d-none d-lg-block">
        <div class="input-group" style="width: 250px;">
          <input type="text" class="form-control form-control-sm" placeholder="Quick search..." id="topSearchInput">
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="performQuickSearch()">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Notifications -->
      <div class="nav-item dropdown me-3">
        <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-bell fs-5"></i>
          <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 320px;">
          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
            <h6 class="mb-0">Notifications</h6>
            <button class="btn btn-sm btn-link text-primary p-0" onclick="markAllAsRead()">Mark all as read</button>
          </div>
          <div class="notification-list" id="notificationList" style="max-height: 300px; overflow-y: auto;">
            <!-- Dynamic notifications will be loaded here -->
            <div class="text-center py-3" id="noNotifications" style="display: none;">
              <i class="bi bi-bell-slash text-muted fs-4"></i>
              <div class="text-muted mt-2">No notifications yet</div>
            </div>
          </div>
          <div class="text-center py-2 border-top">
            <a href="#" class="btn btn-sm btn-link">View all notifications</a>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="nav-item dropdown me-3">
        <a class="nav-link position-relative" href="#" id="messageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-chat-dots fs-5"></i>
          <span class="notification-badge" style="background-color: var(--success-color);">2</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="messageDropdown" style="width: 300px;">
          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
            <h6 class="mb-0">Messages</h6>
            <a href="#" class="btn btn-sm btn-link text-primary p-0">View all</a>
          </div>
          <div class="notification-list" style="max-height: 250px; overflow-y: auto;">
            <div class="notification-item">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">WM</div>
                <div class="flex-grow-1">
                  <div class="notification-title">Warehouse Manager</div>
                  <div class="notification-text">Scanner calibration completed successfully</div>
                  <div class="notification-time">1 hour ago</div>
                </div>
              </div>
            </div>
            <div class="notification-item">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">SM</div>
                <div class="flex-grow-1">
                  <div class="notification-title">System Manager</div>
                  <div class="notification-text">New barcode format detected</div>
                  <div class="notification-time">2 hours ago</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Profile -->
      <div class="nav-item dropdown">
        <a class="nav-link d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <div class="user-avatar me-2" id="userAvatar">SC</div>
          <div class="d-none d-md-block">
            <div id="userName" style="font-size: 0.875rem; font-weight: 600; line-height: 1.2;">John Doe</div>
          </div>
          <i class="bi bi-chevron-down ms-2"></i>
        </a>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
          <div class="px-3 py-2 border-bottom">
            <div class="fw-bold" id="userFullNameDropdown">John Doe</div>
            <div class="text-muted small" id="userEmailDropdown">scanner@foxcontrolhub.com</div>
          </div>
          <a class="dropdown-item" href="#" onclick="showProfileModal()">
            <i class="bi bi-person me-2"></i>My Profile
          </a>
          <a class="dropdown-item" href="#" onclick="showSettingsModal()">
            <i class="bi bi-gear me-2"></i>Settings
          </a>
          <a class="dropdown-item" href="#">
            <i class="bi bi-question-circle me-2"></i>Help & Support
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#" onclick="showActivityLog()">
            <i class="bi bi-clock-history me-2"></i>Activity Log
          </a>
          <a class="dropdown-item" href="#">
            <i class="bi bi-shield-check me-2"></i>Security
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item text-danger" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>Sign Out
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2 col-md-3 sidebar p-3">
      <nav class="nav flex-column">
        <a class="nav-link" href="Inventory.html"><i class="bi bi-box-seam me-2"></i>Inventory</a>
        <a class="nav-link active" href="Barcode.html"><i class="bi bi-upc-scan me-2"></i>Barcode</a>
        <a class="nav-link" href="WarehouseLayAndOpti.html"><i class="bi bi-layout-wtf me-2"></i>Layout & Optimization</a>
        <a class="nav-link" href="MaterialShipments.html"><i class="bi bi-truck me-2"></i>Material Shipments</a>
        <a class="nav-link" href="OrderShipments.html"><i class="bi bi-box-arrow-right me-2"></i>Order Shipments</a>
        <a class="nav-link" href="StockTracking.html"><i class="bi bi-shop me-2"></i>Stock Tracking</a>
        <a class="nav-link" href="Reports.html"><i class="bi bi-graph-up me-2"></i>Reports</a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="col-lg-10 col-md-9 p-3">
      <!-- Top Panel -->
      <div class="top-panel">
        <h4 class="fw-bold">Barcode Scanner</h4>
        <div class="d-flex flex-wrap justify-content-start action-buttons">
          <button class="btn" onclick="startBarcodeScanner()">
            <i class="bi bi-upc-scan"></i>Start Barcode Scanner
          </button>

          <button class="btn" onclick="exportScanHistory()">
            <i class="bi bi-download"></i>Export History
          </button>
          <button class="btn" onclick="clearScanHistory()">
            <i class="bi bi-trash"></i>Clear History
          </button>
          <button class="btn" onclick="loadInventoryData()">
            <i class="bi bi-arrow-clockwise"></i>Refresh Data
          </button>
          <button class="btn" onclick="loadScanHistoryFromDatabase()">
            <i class="bi bi-database"></i>Load History
          </button>
        </div>
      </div>

      <!-- Scanner Section -->
      <div class="scanner-card">
        <h5><i class="bi bi-camera me-2"></i>Scanner Interface</h5>
        
        <!-- Scanner Status -->
        <div class="mb-3">
          <span class="status-indicator status-ready" id="statusIndicator"></span>
          <span id="statusText">Ready to scan</span>
        </div>

        <!-- Scanner Controls -->
        <div class="scanner-controls">
          <button class="btn btn-outline-success" onclick="continuousScan()" id="continuousBtn">
            <i class="bi bi-arrow-repeat"></i> Continuous Scan
          </button>
        </div>

        <!-- Scanner Area -->
        <div class="scanner-area" id="scannerArea">
          <i class="bi bi-upc-scan" style="font-size: 3rem; color: var(--body-font); margin-bottom: 1rem;"></i>
          <h6>Point camera at barcode or RFID tag</h6>
          <p class="text-muted">Or manually enter code below</p>
        </div>

        <!-- Manual Input -->
        <input type="text" class="form-control scanner-input" id="manualInput" 
               placeholder="Scan or type barcode/RFID code here..." 
               onkeypress="handleManualInput(event)">

        <!-- Current Scan Result -->
        <div class="scan-result" id="scanResult" style="display: none;">
          <h6>Scan Result:</h6>
          <div id="resultContent"></div>
        </div>
      </div>

      <!-- Scan History -->
      <div class="scanner-card">
        <h5><i class="bi bi-clock-history me-2"></i>Scan History</h5>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-muted">Total scans: <span id="scanCount">0</span></span>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="filterHistory('all')">All</button>
            <button class="btn btn-sm btn-outline-primary" onclick="filterHistory('barcode')">Barcode</button>
            <button class="btn btn-sm btn-outline-success" onclick="filterHistory('rfid')">RFID</button>
          </div>
        </div>
        
        <div class="scan-history" id="scanHistory">
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p>No scans yet. Start scanning to see history here.</p>
          </div>
        </div>
      </div>
      
      <!-- Barcode Generation Section -->
      <div class="scanner-card">
        <h5><i class="bi bi-upc-scan me-2"></i>Inventory Barcode Generator</h5>
        <p class="text-muted">Generate barcodes for inventory items</p>
        
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Search Items</label>
            <input type="text" class="form-control" id="barcodeSearchInput" 
                   placeholder="Search by name or code..." onkeyup="filterBarcodeItems()">
          </div>
          <div class="col-md-4">
            <label class="form-label">Category</label>
            <select class="form-select" id="barcodeCategoryFilter" onchange="filterBarcodeItems()">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Warehouse</label>
            <select class="form-select" id="barcodeWarehouseFilter" onchange="filterBarcodeItems()">
              <option value="">All Warehouses</option>
            </select>
            </div>
        </div>
        
        <div class="barcode-items-grid" id="barcodeItemsGrid">
          <div class="text-center text-muted py-4">
            <i class="bi bi-upc-scan" style="font-size: 2rem;"></i>
            <p>Loading inventory items...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Item Lookup Modal -->
<div class="modal fade" id="itemLookupModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Item Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="itemDetailsContent">
          <!-- Item details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="updateInventoryQuantity()">Update Quantity</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Scanner Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <!-- Scanner Settings -->
          <div class="col-12">
            <h6 class="border-bottom pb-2 mb-3">Scanner Configuration</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Default Scanner Mode</label>
                <select class="form-select" id="defaultScannerMode">
                  <option value="barcode" selected>Barcode</option>
                  <option value="rfid">RFID</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Scan Timeout (seconds)</label>
                <input type="number" class="form-control" id="scanTimeout" value="30" min="10" max="120">
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="autoLookup" checked>
                  <label class="form-check-label" for="autoLookup">
                    Auto-lookup items after scan
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="playBeepSound" checked>
                  <label class="form-check-label" for="playBeepSound">
                    Play beep sound on successful scan
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Display Settings -->
          <div class="col-12">
            <h6 class="border-bottom pb-2 mb-3">Display Settings</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">History Display Limit</label>
                <select class="form-select" id="historyLimit">
                  <option value="50">50 items</option>
                  <option value="100" selected>100 items</option>
                  <option value="200">200 items</option>
                  <option value="500">500 items</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date Format</label>
                <select class="form-select" id="dateFormat">
                  <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                  <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                  <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">My Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-md-4 text-center">
            <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;" id="profileAvatar">SC</div>
            <button class="btn btn-outline-primary btn-sm">Change Avatar</button>
          </div>
          <div class="col-md-8">
            <form id="profileForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" value="Scanner" id="firstName">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" value="Operator" id="lastName">
                </div>
                <div class="col-12">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" value="scanner@foxcontrolhub.com" id="email">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" value="+1 (555) 987-6543" id="phone">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Department</label>
                  <select class="form-select" id="department">
                    <option value="warehouse" selected>Warehouse Operations</option>
                    <option value="inventory">Inventory Management</option>
                    <option value="quality">Quality Control</option>
                    <option value="shipping">Shipping & Receiving</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Bio</label>
                  <textarea class="form-control" rows="3" id="bio">Experienced scanner operator specializing in barcode and RFID systems for inventory management.</textarea>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Scanning Activity Log</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>Code</th>
                <th>Type</th>
                <th>Item</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="activityLogBody">
              <!-- Activity log will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="exportActivityLog()">Export Log</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global variables
let scanHistory = [];
let inventoryData = [];
let categoriesData = [];
let warehousesData = [];
let currentItem = null;
let isScanning = false;
let scannerMode = 'barcode'; // 'barcode' or 'rfid'
let continuousMode = false;
let scanTimeout = 30;
let autoLookup = true;
let playBeepSound = true;
let currentUser = null;

// API Helper Functions
const API_BASE = '/api';

async function apiCall(endpoint, options = {}) {
  try {
    const response = await fetch(`${API_BASE}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

// Initialize scanner
document.addEventListener('DOMContentLoaded', function() {
  loadInitialData();
  fetchUser();
  loadNotifications();
  loadNotificationCount();
  updateScanCount();
  focusInput();
});

// Load initial data from database
async function loadInitialData() {
  try {
    showLoading(true);
    const [inventoryResponse, categoriesResponse, warehousesResponse] = await Promise.all([
      apiCall('/inventory'),
      apiCall('/categories'),
      apiCall('/warehouses')
    ]);
    
    if (inventoryResponse.success) {
      inventoryData = mapInventoryData(inventoryResponse.data);
      showMessage('Inventory data loaded successfully');
      
          // After loading inventory, load scan history from database
    await loadScanHistoryFromDatabase();
    
    // Populate barcode generation section
    populateBarcodeItems();
    populateBarcodeFilters();
  }
    
    if (categoriesResponse.success) {
      categoriesData = categoriesResponse.data;
    }
    
    if (warehousesResponse.success) {
      warehousesData = warehousesResponse.data;
    }
    
  } catch (error) {
    console.error('Error loading initial data:', error);
    showMessage('Error loading data from database. Operating in offline mode.', 'warning');
  } finally {
    showLoading(false);
  }
}

// Map raw inventory data to internal format
function mapInventoryData(rawData) {
  return rawData.map(item => ({
    id: item.id,
    itemCode: item.item_code,
    productName: item.product_name,
    unitOfMeasure: item.unit_of_measure,
    buyPrice: item.buy_price,
    sellPrice: item.sell_price,
    location: item.location,
    categoryId: item.category_id,
    status: item.status,
    warehouseId: item.warehouse_id,
    totalQuantity: item.total_quantity,
    updatedAt: item.updated_at
  }));
}

function showLoading(show) {
  const statusText = document.getElementById('statusText');
  if (show) {
    statusText.textContent = 'Loading data...';
    updateStatus('scanning', 'Loading data...');
  } else {
    statusText.textContent = 'Ready to scan';
    updateStatus('ready', 'Ready to scan');
  }
}

function showMessage(message, type = 'info') {
  // Create notification if needed
  addNotification(message, type);
  
  // Show temporary toast-like message
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} alert-dismissible fade show position-fixed`;
  alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alertDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}

function startBarcodeScanner() {
  scannerMode = 'barcode';
  updateScannerMode();
  startScanning();
}



function startScanning() {
  isScanning = true;
  updateStatus('scanning', `Scanning for ${scannerMode.toUpperCase()}...`);
  document.getElementById('scannerArea').classList.add('active');
  focusInput();
  
  // Auto-stop scanning after timeout
  setTimeout(() => {
    if (isScanning && !continuousMode) {
      stopScanning();
    }
  }, scanTimeout * 1000);
}

function stopScanning() {
  isScanning = false;
  updateStatus('ready', 'Scanner stopped');
  document.getElementById('scannerArea').classList.remove('active');
}

function toggleScannerMode() {
  scannerMode = scannerMode === 'barcode' ? 'rfid' : 'barcode';
  updateScannerMode();
}

function updateScannerMode() {
  const modeToggle = document.getElementById('modeToggle');
  const scannerArea = document.getElementById('scannerArea');
  
  if (scannerMode === 'barcode') {
    modeToggle.innerHTML = '<i class="bi bi-toggle-off"></i> Barcode Mode';
    scannerArea.innerHTML = `
      <i class="bi bi-upc-scan" style="font-size: 3rem; color: var(--body-font); margin-bottom: 1rem;"></i>
      <h6>Point camera at barcode</h6>
      <p class="text-muted">Or manually enter barcode below</p>
    `;
  } else {
    modeToggle.innerHTML = '<i class="bi bi-toggle-on"></i> RFID Mode';
    scannerArea.innerHTML = `
      <i class="bi bi-broadcast" style="font-size: 3rem; color: var(--body-font); margin-bottom: 1rem;"></i>
      <h6>Hold RFID tag near reader</h6>
      <p class="text-muted">Or manually enter RFID code below</p>
    `;
  }
  
  document.getElementById('manualInput').placeholder = 
    `Scan or type ${scannerMode} code here...`;
}

function continuousScan() {
  continuousMode = !continuousMode;
  const btn = document.getElementById('continuousBtn');
  
  if (continuousMode) {
    btn.innerHTML = '<i class="bi bi-pause"></i> Stop Continuous';
    btn.classList.remove('btn-outline-success');
    btn.classList.add('btn-success');
    startScanning();
  } else {
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Continuous Scan';
    btn.classList.remove('btn-success');
    btn.classList.add('btn-outline-success');
    stopScanning();
  }
}

function handleManualInput(event) {
  if (event.key === 'Enter') {
    const input = event.target;
    const code = input.value.trim();
    
    if (code) {
      processScan(code, scannerMode);
      input.value = '';
      
      if (!continuousMode) {
        stopScanning();
      }
    }
  }
}

async function processScan(code, type) {
  const timestamp = new Date();
  const scanData = {
    id: Date.now(),
    code: code,
    type: type,
    timestamp: timestamp,
    status: 'success',
    item: null
  };
  
  // Try to find item in inventory using multiple barcode formats
  if (inventoryData.length > 0) {
    const foundItem = inventoryData.find(item => {
      // Check exact item code match
      if (item.itemCode === code) return true;
      
      // Check ID match
      if (item.id.toString() === code) return true;
      
      // Check combined format (itemCode-id)
      if (`${item.itemCode}-${item.id}` === code) return true;
      
      // Check if code contains item code (for partial matches)
      if (code.includes(item.itemCode)) return true;
      
      // Check if item code contains the scanned code (for partial matches)
      if (item.itemCode.includes(code)) return true;
      
      return false;
    });
    
    if (foundItem) {
      scanData.item = foundItem;
      scanData.status = 'found';
      scanData.itemId = foundItem.id;
      scanData.productName = foundItem.productName;
      scanData.quantity = foundItem.totalQuantity;
    } else {
      scanData.status = 'not_found';
    }
  }
  
  // Save to database
  try {
    console.log('Attempting to save scan to database:', { currentUser, scanData });
    
    const dbScanData = {
      code: code,
      type: type,
      itemId: scanData.itemId || null,
      productName: scanData.productName || null,
      quantity: scanData.quantity || 1,
      status: scanData.status,
      scannedBy: currentUser?.username || 'unknown',
      notes: `Scanned at ${timestamp.toLocaleString()}`
    };
    
    console.log('Sending scan data to database:', dbScanData);
    
    // Try to save to database
    const savedScan = await apiCall('/scan-history', {
      method: 'POST',
      body: JSON.stringify(dbScanData)
    });
    
    console.log('Database save response:', savedScan);
    
    if (savedScan.success) {
      scanData.dbId = savedScan.data.id;
      scanData.dbCreatedAt = savedScan.data.created_at;
      console.log('Scan saved to database successfully');
    } else {
      console.log('Database save failed:', savedScan);
    }
  } catch (error) {
    console.error('Error saving scan to database:', error);
    // Continue with local storage if database fails
  }
  
  // Add to local history
  scanHistory.unshift(scanData);
  
  // Limit history size
  const historyLimit = parseInt(document.getElementById('historyLimit')?.value || 100);
  if (scanHistory.length > historyLimit) {
    scanHistory = scanHistory.slice(0, historyLimit);
  }
  
  // Show result
  showScanResult(scanData);
  
  // Update history display
  updateScanHistory();
  updateScanCount();
  
  // Auto-lookup if enabled
  if (autoLookup && scanData.item) {
    setTimeout(() => lookupItem(code), 1000);
  }
  
  // Play success sound
  if (playBeepSound) {
    playBeep();
  }
  
  // Log activity
  logActivity('scan', code, type, scanData.item?.productName || 'Unknown', scanData.status);
}

// Barcode generation function
function generateBarcode(text, elementId) {
  try {
    // Simple barcode generation using canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const width = 200;
    const height = 60;
    
    canvas.width = width;
    canvas.height = height;
    
    // Clear canvas
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, width, height);
    
    // Draw barcode bars (simple representation)
    ctx.fillStyle = 'black';
    const barWidth = 2;
    let x = 10;
    
    for (let i = 0; i < text.length; i++) {
      const charCode = text.charCodeAt(i);
      const barHeight = (charCode % 3 + 1) * 15 + 10;
      const y = (height - barHeight) / 2;
      
      ctx.fillRect(x, y, barWidth, barHeight);
      x += barWidth + 1;
      
      // Add some spacing between characters
      if (i < text.length - 1) {
        x += 2;
      }
    }
    
    // Add text below barcode
    ctx.fillStyle = 'black';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(text, width / 2, height - 5);
    
    // Display the barcode
    const barcodeDiv = document.getElementById(`barcode-${elementId}`);
    if (barcodeDiv) {
      barcodeDiv.innerHTML = '';
      barcodeDiv.appendChild(canvas);
    }
    
    showMessage(`Barcode generated for: ${text}`, 'success');
  } catch (error) {
    console.error('Error generating barcode:', error);
    showMessage('Error generating barcode', 'error');
  }
}

function showScanResult(scanData) {
  const resultDiv = document.getElementById('scanResult');
  const contentDiv = document.getElementById('resultContent');
  
  let statusBadge, statusText, itemInfo = '';
  
  switch(scanData.status) {
    case 'found':
      statusBadge = '<span class="badge bg-success">Item Found</span>';
      statusText = 'Item found in inventory';
      itemInfo = `
        <div class="mt-2">
          <strong>Product:</strong> ${scanData.item.productName}<br>
          <strong>Location:</strong> ${scanData.item.location}<br>
          <strong>Quantity:</strong> ${scanData.item.totalQuantity}
        </div>
      `;
      break;
    case 'not_found':
      statusBadge = '<span class="badge bg-warning">Not Found</span>';
      statusText = 'Item not found in inventory';
      break;
    default:
      statusBadge = '<span class="badge bg-info">Scanned</span>';
      statusText = 'Code scanned successfully';
  }
  
  contentDiv.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <strong>Code:</strong> ${scanData.code}<br>
        <strong>Type:</strong> ${scanData.type.toUpperCase()}<br>
        <strong>Time:</strong> ${scanData.timestamp.toLocaleTimeString()}
        ${itemInfo}
      </div>
      <div class="col-md-6">
        <strong>Status:</strong> ${statusBadge}<br>
        <small class="text-muted">${statusText}</small><br>
        <div class="mt-2">
          <button class="btn btn-sm btn-primary me-2" onclick="lookupItem('${scanData.code}')">
            <i class="bi bi-search"></i> Lookup
          </button>
          ${scanData.item ? `<button class="btn btn-sm btn-success" onclick="quickUpdate('${scanData.code}')">
            <i class="bi bi-pencil"></i> Quick Update
          </button>` : ''}
        </div>
      </div>
    </div>
  `;
  
  resultDiv.style.display = 'block';
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    resultDiv.style.display = 'none';
  }, 10000);
}

function updateScanHistory() {
  const historyDiv = document.getElementById('scanHistory');
  
  if (scanHistory.length === 0) {
    historyDiv.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
        <p>No scans yet. Start scanning to see history here.</p>
      </div>
    `;
    return;
  }
  
  historyDiv.innerHTML = scanHistory.map(scan => {
    let statusIcon, statusClass;
    
    switch(scan.status) {
      case 'found':
        statusIcon = '<i class="bi bi-check-circle-fill text-success"></i>';
        statusClass = 'border-success';
        break;
      case 'not_found':
        statusIcon = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
        statusClass = 'border-warning';
        break;
      default:
        statusIcon = '<i class="bi bi-info-circle-fill text-info"></i>';
        statusClass = '';
    }
    
    return `
      <div class="scan-item ${scan.type} ${statusClass}" data-type="${scan.type}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center mb-1">
              ${statusIcon}
              <strong class="ms-2">${scan.code}</strong>
              ${scan.item ? `<span class="badge bg-info ms-2">${scan.item.productName}</span>` : ''}
            </div>
            <small class="text-muted">
              <i class="bi bi-${scan.type === 'barcode' ? 'upc-scan' : 'broadcast'}"></i>
              ${scan.type.toUpperCase()} • ${scan.timestamp.toLocaleString()}
              ${scan.item ? ` • Qty: ${scan.item.totalQuantity}` : ''}
            </small>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="lookupItem('${scan.code}')" title="Lookup">
              <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="removeScan(${scan.id})">
              <i class="bi bi-trash"></i> Remove
          </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateScanCount() {
  document.getElementById('scanCount').textContent = scanHistory.length;
}

function updateStatus(status, message) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  
  indicator.className = `status-indicator status-${status}`;
  text.textContent = message;
}

function filterHistory(type) {
  const items = document.querySelectorAll('.scan-item');
  
  items.forEach(item => {
    if (type === 'all' || item.dataset.type === type) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

async function lookupItem(code) {
  try {
    // First try to find in local data
    let item = inventoryData.find(item => 
      item.itemCode === code || 
      item.id.toString() === code ||
      `${item.itemCode}-${item.id}` === code
    );
    
    // If not found locally, try API
    if (!item && inventoryData.length > 0) {
      try {
        const response = await apiCall(`/inventory/search?code=${encodeURIComponent(code)}`);
        if (response.success && response.data) {
          item = mapInventoryData([response.data])[0];
        }
      } catch (error) {
        console.log('API search failed, using local data only');
      }
    }
    
    if (item) {
      currentItem = item;
      showItemDetails(item);
    } else {
      showMessage(`Item with code "${code}" not found in inventory.`, 'warning');
    }
  } catch (error) {
    console.error('Error looking up item:', error);
    showMessage('Error looking up item', 'error');
  }
}

function showItemDetails(item) {
  const modal = new bootstrap.Modal(document.getElementById('itemLookupModal'));
  const content = document.getElementById('itemDetailsContent');
  
  // Get category and warehouse names
  const category = categoriesData.find(c => c.category_id === item.categoryId);
  const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
  
  content.innerHTML = `
    <div class="item-details">
      <div class="row g-3">
        <div class="col-md-6">
          <strong>Item Code:</strong> ${item.itemCode}<br>
          <strong>Product Name:</strong> ${item.productName}<br>
          <strong>Status:</strong> <span class="badge ${item.status === 'active' ? 'bg-success' : 'bg-danger'}">${item.status}</span>
        </div>
        <div class="col-md-6">
          <strong>Current Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}<br>
          <strong>Location:</strong> ${item.location}<br>
          <strong>Buy Price:</strong> ₱${item.buyPrice}
        </div>
        <div class="col-md-6">
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}
        </div>
        <div class="col-md-6">
          <strong>Sell Price:</strong> ₱${item.sellPrice || 'N/A'}<br>
          <strong>Last Updated:</strong> ${new Date(item.updatedAt).toLocaleString()}
        </div>
      </div>
      
      <div class="quantity-controls">
        <label class="form-label">Update Quantity:</label>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity(-1)">-</button>
          <input type="number" class="form-control" id="newQuantity" value="${item.totalQuantity}" min="0" style="width: 100px;">
          <button class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity(1)">+</button>
          <span class="text-muted">${item.unitOfMeasure}</span>
        </div>
      </div>
      
      <div class="quantity-actions">
        <button class="btn btn-sm btn-success" onclick="setQuickQuantity(0)">Set to 0</button>
        <button class="btn btn-sm btn-warning" onclick="setQuickQuantity(10)">+10</button>
        <button class="btn btn-sm btn-info" onclick="setQuickQuantity(50)">+50</button>
        <button class="btn btn-sm btn-primary" onclick="setQuickQuantity(100)">+100</button>
      </div>
      
      <div class="barcode-section mt-3">
        <h6>Generated Barcodes:</h6>
        <div class="row g-2">
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>Item Code:</strong> ${item.itemCode}
              <div class="barcode-display" id="barcode-${item.itemCode}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.itemCode}', '${item.itemCode}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>ID:</strong> ${item.id}
              <div class="barcode-display" id="barcode-id-${item.id}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.id}', 'id-${item.id}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>Combined:</strong> ${item.itemCode}-${item.id}
              <div class="barcode-display" id="barcode-combined-${item.id}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.itemCode}-${item.id}', 'combined-${item.id}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  modal.show();
}

function adjustQuantity(delta) {
  const input = document.getElementById('newQuantity');
  const currentValue = parseInt(input.value) || 0;
  const newValue = Math.max(0, currentValue + delta);
  input.value = newValue;
}

function setQuickQuantity(value) {
  const input = document.getElementById('newQuantity');
  if (value === 0) {
    input.value = 0;
  } else {
    const currentValue = parseInt(input.value) || 0;
    input.value = currentValue + value;
  }
}

async function updateInventoryQuantity() {
  if (!currentItem) return;
  
  const newQuantity = parseInt(document.getElementById('newQuantity').value);
  if (isNaN(newQuantity) || newQuantity < 0) {
    showMessage('Please enter a valid quantity', 'error');
    return;
  }
  
  try {
    const response = await apiCall(`/inventory/${currentItem.id}`, {
      method: 'PUT',
      body: JSON.stringify({
        total_quantity: newQuantity
      })
    });
    
    if (response.success) {
      // Update local data
      currentItem.totalQuantity = newQuantity;
      const index = inventoryData.findIndex(item => item.id === currentItem.id);
      if (index !== -1) {
        inventoryData[index].totalQuantity = newQuantity;
      }
      
      showMessage(`Quantity updated successfully for ${currentItem.productName}`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('itemLookupModal')).hide();
      
      // Log activity
      logActivity('update', currentItem.itemCode, 'quantity', currentItem.productName, 'success');
      
      // Refresh notifications
      refreshNotifications();
    } else {
      showMessage(response.message || 'Failed to update quantity', 'error');
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
    showMessage('Error updating quantity', 'error');
  }
}

function quickUpdate(code) {
  lookupItem(code);
}

async function removeScan(scanId) {
  try {
    // First try to delete from database if it has a database ID
    const scan = scanHistory.find(s => s.id === scanId);
    
    if (scan && scan.dbId) {
      console.log('Attempting to delete scan from database:', scan.dbId);
      
      const response = await apiCall(`/scan-history/${scan.dbId}`, {
        method: 'DELETE'
      });
      
      if (response.success) {
        console.log('Scan deleted from database successfully');
      } else {
        console.log('Failed to delete scan from database:', response);
        // Continue with local deletion even if database fails
      }
    } else {
      console.log('Scan has no database ID, deleting locally only');
    }
    
    // Remove from local history
    scanHistory = scanHistory.filter(scan => scan.id !== scanId);
    updateScanHistory();
    updateScanCount();
    
    showMessage('Scan removed from history', 'success');
    logActivity('remove_scan', `Removed scan ID: ${scanId}`);
    
  } catch (error) {
    console.error('Error removing scan:', error);
    showMessage('Error removing scan from history', 'error');
  }
}

function exportScanHistory() {
  if (scanHistory.length === 0) {
    alert('No scan history to export.');
    return;
  }
  
  const csvContent = "data:text/csv;charset=utf-8," 
    + "Code,Type,Timestamp,Status,Item,Quantity\n"
    + scanHistory.map(scan => 
        `${scan.code},${scan.type},${scan.timestamp.toISOString()},${scan.status},${scan.item?.productName || 'N/A'},${scan.item?.totalQuantity || 'N/A'}`
      ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `scan_history_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function clearScanHistory() {
  if (confirm('Are you sure you want to clear all scan history? This will clear both local and database history.')) {
    try {
      // Clear from database
      const response = await apiCall('/scan-history', {
        method: 'DELETE'
      });
      
      if (response.success) {
        showMessage('Database scan history cleared successfully', 'success');
      }
    } catch (error) {
      console.error('Error clearing database history:', error);
      showMessage('Database history could not be cleared', 'warning');
    }
    
    // Clear local history
    scanHistory = [];
    updateScanHistory();
    updateScanCount();
    document.getElementById('scanResult').style.display = 'none';
    showMessage('Local scan history cleared', 'info');
  }
}

async function loadScanHistoryFromDatabase() {
  try {
    console.log('Loading scan history from database...');
    showLoading(true);
    const response = await apiCall('/scan-history');
    
    console.log('Database response:', response);
    
    if (response.success && response.data) {
      console.log('Received scan history from database:', response.data);
      
      // Convert database format to local format
      const dbHistory = response.data.map(dbScan => ({
        id: dbScan.id,
        code: dbScan.scanned_code,
        type: dbScan.scan_type,
        timestamp: new Date(dbScan.created_at),
        status: dbScan.scan_status,
        item: dbScan.item_id ? inventoryData.find(item => item.id === dbScan.item_id) : null,
        itemId: dbScan.item_id,
        productName: dbScan.product_name,
        quantity: dbScan.quantity,
        dbId: dbScan.id,
        dbCreatedAt: dbScan.created_at,
        notes: dbScan.notes
      }));
      
      // Merge with local history, avoiding duplicates
      const existingIds = new Set(scanHistory.map(scan => scan.dbId || scan.id));
      const newDbScans = dbHistory.filter(dbScan => !existingIds.has(dbScan.dbId));
      
      if (newDbScans.length > 0) {
        scanHistory = [...newDbScans, ...scanHistory];
        console.log(`Added ${newDbScans.length} new scans from database`);
        showMessage(`Loaded ${newDbScans.length} scans from database`, 'success');
      } else {
        console.log('No new scans found in database');
      }
      
      updateScanHistory();
      updateScanCount();
    } else {
      console.log('No scan history data received from database');
    }
  } catch (error) {
    console.error('Error loading scan history from database:', error);
    showMessage('Could not load scan history from database', 'warning');
  } finally {
    showLoading(false);
  }
}

function focusInput() {
  setTimeout(() => {
    document.getElementById('manualInput').focus();
  }, 100);
}

function playBeep() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'square';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (error) {
    console.log('Could not play beep sound');
  }
}

// Auto-focus input when page becomes visible
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    focusInput();
  }
});

// Top Navigation Functions
function performQuickSearch() {
  const searchTerm = document.getElementById('topSearchInput').value.trim();
  if (searchTerm) {
    // Simulate scan
    processScan(searchTerm, 'manual');
    document.getElementById('topSearchInput').value = '';
  }
}

async function fetchUser() {
  try {
    const response = await apiCall('/user');
    if (response.success && response.data) {
      currentUser = response.data;
      displayUser(response.data);
    }
  } catch (error) {
    console.error('Failed to fetch user:', error);
    // Use default user data
    currentUser = { username: 'scanner' };
    displayUser({ username: 'scanner' });
  }
}

function displayUser(user) {
  const username = user.username.charAt(0).toUpperCase() + user.username.slice(1);
  document.getElementById('userName').textContent = username;

  const initials = username.substring(0, 2).toUpperCase();
  const userAvatar = document.getElementById('userAvatar');
  if (userAvatar) {
    userAvatar.textContent = initials;
  }

  const profileAvatar = document.getElementById('profileAvatar');
  if (profileAvatar) {
    profileAvatar.textContent = initials;
  }

  const userFullNameDropdown = document.getElementById('userFullNameDropdown');
  const userEmailDropdown = document.getElementById('userEmailDropdown');
  if (userFullNameDropdown) {
    userFullNameDropdown.textContent = username;
  }
  if (userEmailDropdown) {
    userEmailDropdown.textContent = `${user.username}@foxcontrolhub.com`;
  }
}

// Notification functions
async function loadNotifications() {
  try {
    const response = await apiCall('/notifications');
    if (response.success) {
      displayNotifications(response.data);
    }
  } catch (error) {
    console.error('Failed to load notifications:', error);
  }
}

async function loadNotificationCount() {
  try {
    const response = await apiCall('/notifications/count');
    if (response.success) {
      updateNotificationCount(response.count);
    }
  } catch (error) {
    console.error('Failed to load notification count:', error);
  }
}

function displayNotifications(notifications) {
  const notificationList = document.getElementById('notificationList');
  const noNotifications = document.getElementById('noNotifications');
  
  if (!notifications || notifications.length === 0) {
    noNotifications.style.display = 'block';
    return;
  }
  
  noNotifications.style.display = 'none';
  notificationList.innerHTML = '';
  
  notifications.forEach(notification => {
    const notificationItem = document.createElement('div');
    notificationItem.className = `notification-item ${!notification.is_read ? 'notification-unread' : ''}`;
    notificationItem.setAttribute('data-id', notification.id);
    
    const timeAgo = formatTimeAgo(new Date(notification.created_at));
    const icon = getNotificationIcon(notification.type);
    
    notificationItem.innerHTML = `
      <div class="d-flex align-items-start">
        <div class="me-2 mt-1">${icon}</div>
        <div class="flex-grow-1" onclick="markNotificationAsRead(${notification.id})">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-text">${notification.message}</div>
          <div class="notification-time">${timeAgo}</div>
        </div>
      </div>
    `;
    
    notificationList.appendChild(notificationItem);
  });
}

function getNotificationIcon(type) {
  switch (type) {
    case 'success':
      return '<i class="bi bi-check-circle-fill text-success"></i>';
    case 'warning':
      return '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
    case 'error':
      return '<i class="bi bi-x-circle-fill text-danger"></i>';
    case 'info':
    default:
      return '<i class="bi bi-info-circle-fill text-primary"></i>';
  }
}

function formatTimeAgo(date) {
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 60) {
    return 'Just now';
  } else if (diffInSeconds < 3600) {
    const minutes = Math.floor(diffInSeconds / 60);
    return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  } else if (diffInSeconds < 86400) {
    const hours = Math.floor(diffInSeconds / 3600);
    return `${hours} hour${hours > 1 ? 's' : ''} ago`;
  } else {
    const days = Math.floor(diffInSeconds / 86400);
    return `${days} day${days > 1 ? 's' : ''} ago`;
  }
}

function updateNotificationCount(count) {
  const notificationCount = document.getElementById('notificationCount');
  if (count > 0) {
    notificationCount.textContent = count;
    notificationCount.style.display = 'flex';
  } else {
    notificationCount.style.display = 'none';
  }
}

async function markNotificationAsRead(id) {
  try {
    const response = await apiCall(`/notifications/${id}/read`, {
      method: 'POST'
    });
    if (response.success) {
      const notificationItem = document.querySelector(`[data-id="${id}"]`);
      if (notificationItem) {
        notificationItem.classList.remove('notification-unread');
      }
      loadNotificationCount();
    }
  } catch (error) {
    console.error('Failed to mark notification as read:', error);
  }
}

async function markAllAsRead() {
  try {
    const response = await apiCall('/notifications/read-all', {
      method: 'POST'
    });
    if (response.success) {
      const unreadNotifications = document.querySelectorAll('.notification-unread');
      unreadNotifications.forEach(notification => {
        notification.classList.remove('notification-unread');
      });
      updateNotificationCount(0);
    }
  } catch (error) {
    console.error('Failed to mark all notifications as read:', error);
  }
}

function addNotification(message, type) {
  // Add to notifications (would normally be done server-side)
  try {
    apiCall('/notifications', {
      method: 'POST',
      body: JSON.stringify({
        title: 'Scanner Activity',
        message: message,
        type: type
      })
    });
  } catch (error) {
    console.log('Could not create notification');
  }
}

function refreshNotifications() {
  loadNotifications();
  loadNotificationCount();
}

// Modal functions
function showSettingsModal() {
  new bootstrap.Modal(document.getElementById('settingsModal')).show();
}

function showProfileModal() {
  new bootstrap.Modal(document.getElementById('profileModal')).show();
}

function showActivityLog() {
  populateActivityLog();
  new bootstrap.Modal(document.getElementById('activityModal')).show();
}

function saveSettings() {
  // Get settings data
  scanTimeout = parseInt(document.getElementById('scanTimeout').value) || 30;
  autoLookup = document.getElementById('autoLookup').checked;
  playBeepSound = document.getElementById('playBeepSound').checked;
  
  // Save to localStorage
  localStorage.setItem('scannerSettings', JSON.stringify({
    scanTimeout,
    autoLookup,
    playBeepSound,
    defaultScannerMode: document.getElementById('defaultScannerMode').value,
    historyLimit: document.getElementById('historyLimit').value,
    dateFormat: document.getElementById('dateFormat').value
  }));
  
  showMessage('Settings saved successfully!', 'success');
  bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
}

function saveProfile() {
  const profileData = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    department: document.getElementById('department').value,
    bio: document.getElementById('bio').value
  };
  
  // Save to localStorage (in real app, would save to server)
  localStorage.setItem('userProfile', JSON.stringify(profileData));
  
  showMessage('Profile updated successfully!', 'success');
  bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
}

async function logout() {
  if (confirm('Are you sure you want to sign out?')) {
    try {
      const response = await fetch('/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.location.href = '/loginpage.html';
      } else {
        alert('Error signing out. Please try again.');
      }
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/loginpage.html';
    }
  }
}

// Activity logging
function logActivity(action, code, type, item, status) {
  const activity = {
    timestamp: new Date(),
    action: action,
    code: code,
    type: type,
    item: item,
    status: status
  };
  
  // Save to localStorage (in real app, would save to server)
  let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  activityLog.unshift(activity);
  
  // Keep only last 1000 activities
  if (activityLog.length > 1000) {
    activityLog = activityLog.slice(0, 1000);
  }
  
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
}

function populateActivityLog() {
  const tbody = document.getElementById('activityLogBody');
  const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  
  tbody.innerHTML = activityLog.map(activity => `
    <tr>
      <td>${new Date(activity.timestamp).toLocaleString()}</td>
      <td>
        <span class="badge ${
          activity.action === 'scan' ? 'bg-info' :
          activity.action === 'update' ? 'bg-warning' :
          'bg-secondary'
        }">${activity.action}</span>
      </td>
      <td>${activity.code}</td>
      <td>${activity.type}</td>
      <td>${activity.item}</td>
      <td>
        <span class="badge ${
          activity.status === 'success' || activity.status === 'found' ? 'bg-success' :
          activity.status === 'not_found' ? 'bg-warning' :
          'bg-danger'
        }">${activity.status}</span>
      </td>
    </tr>
  `).join('');
}

function exportActivityLog() {
  const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  
  if (activityLog.length === 0) {
    alert('No activity log to export.');
    return;
  }
  
  const csvContent = "data:text/csv;charset=utf-8," 
    + "Timestamp,Action,Code,Type,Item,Status\n"
    + activityLog.map(activity => 
        `${activity.timestamp},${activity.action},${activity.code},${activity.type},${activity.item},${activity.status}`
      ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `activity_log_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Load settings on startup
document.addEventListener('DOMContentLoaded', function() {
  const settings = JSON.parse(localStorage.getItem('scannerSettings') || '{}');
  
  if (settings.scanTimeout) {
    scanTimeout = settings.scanTimeout;
    document.getElementById('scanTimeout').value = scanTimeout;
  }
  
  if (settings.autoLookup !== undefined) {
    autoLookup = settings.autoLookup;
    document.getElementById('autoLookup').checked = autoLookup;
  }
  
  if (settings.playBeepSound !== undefined) {
    playBeepSound = settings.playBeepSound;
    document.getElementById('playBeepSound').checked = playBeepSound;
  }
  
  if (settings.defaultScannerMode) {
    scannerMode = settings.defaultScannerMode;
    updateScannerMode();
  }
});

// Manual data refresh function
async function loadInventoryData() {
  try {
    showMessage('Refreshing inventory data...', 'info');
    await loadInitialData();
    showMessage('Inventory data refreshed successfully!', 'success');
  } catch (error) {
    console.error('Error refreshing inventory data:', error);
    showMessage('Error refreshing inventory data', 'error');
  }
}

// Barcode generation functions
function populateBarcodeItems() {
  const grid = document.getElementById('barcodeItemsGrid');
  
  if (!inventoryData || inventoryData.length === 0) {
    grid.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
        <p>No inventory items found. Please refresh data.</p>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = inventoryData.map(item => {
    const category = categoriesData.find(c => c.category_id === item.categoryId);
    const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
    
    return `
      <div class="barcode-item-card">
        <h6>${item.productName}</h6>
        <div class="item-info">
          <strong>Code:</strong> ${item.itemCode}<br>
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}<br>
          <strong>Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}
        </div>
        
        <div class="barcode-preview" id="barcode-preview-${item.id}">
          <span class="text-muted">Click generate to create barcode</span>
        </div>
        
        <div class="barcode-actions">
          <button class="btn btn-sm btn-outline-primary" onclick="generateBarcode('${item.itemCode}', 'preview-${item.id}')">
            <i class="bi bi-upc-scan"></i> Item Code
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="generateBarcode('${item.id}', 'preview-${item.id}')">
            <i class="bi bi-hash"></i> ID
          </button>
          <button class="btn btn-sm btn-outline-info" onclick="generateBarcode('${item.itemCode}-${item.id}', 'preview-${item.id}')">
            <i class="bi bi-link"></i> Combined
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function populateBarcodeFilters() {
  const categoryFilter = document.getElementById('barcodeCategoryFilter');
  const warehouseFilter = document.getElementById('barcodeWarehouseFilter');
  
  // Populate category filter
  if (categoriesData && categoriesData.length > 0) {
    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
      categoriesData.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('');
  }
  
  // Populate warehouse filter
  if (warehousesData && warehousesData.length > 0) {
    warehouseFilter.innerHTML = '<option value="">All Warehouses</option>' +
      warehousesData.map(wh => `<option value="${wh.warehouse_id}">${wh.warehouse_name}</option>`).join('');
  }
}

function filterBarcodeItems() {
  const searchTerm = document.getElementById('barcodeSearchInput').value.toLowerCase();
  const categoryFilter = document.getElementById('barcodeCategoryFilter').value;
  const warehouseFilter = document.getElementById('barcodeWarehouseFilter').value;
  
  const filteredItems = inventoryData.filter(item => {
    const matchesSearch = !searchTerm || 
      item.productName.toLowerCase().includes(searchTerm) ||
      item.itemCode.toLowerCase().includes(searchTerm);
    
    const matchesCategory = !categoryFilter || item.categoryId === categoryFilter;
    const matchesWarehouse = !warehouseFilter || item.warehouseId === warehouseFilter;
    
    return matchesSearch && matchesCategory && matchesWarehouse;
  });
  
  const grid = document.getElementById('barcodeItemsGrid');
  
  if (filteredItems.length === 0) {
    grid.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-search" style="font-size: 2rem;"></i>
        <p>No items match your filters.</p>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = filteredItems.map(item => {
    const category = categoriesData.find(c => c.category_id === item.categoryId);
    const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
    
    return `
      <div class="barcode-item-card">
        <h6>${item.productName}</h6>
        <div class="item-info">
          <strong>Code:</strong> ${item.itemCode}<br>
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}<br>
          <strong>Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}
        </div>
        
        <div class="barcode-preview" id="barcode-preview-${item.id}">
          <span class="text-muted">Click generate to create barcode</span>
        </div>
        
        <div class="barcode-actions">
          <button class="btn btn-sm btn-outline-primary" onclick="generateBarcode('${item.itemCode}', 'preview-${item.id}')">
            <i class="bi bi-upc-scan"></i> Item Code
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="generateBarcode('${item.id}', 'preview-${item.id}')">
            <i class="bi bi-hash"></i> ID
          </button>
          <button class="btn btn-sm btn-outline-info" onclick="generateBarcode('${item.itemCode}-${item.id}', 'preview-${item.id}')">
            <i class="bi bi-link"></i> Combined
          </button>
        </div>
      </div>
    `;
  }).join('');
}


</script>
</body>
</html>
